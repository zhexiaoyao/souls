# Souls-Like 游戏渲染引擎设计方案

## 项目概述
- **项目名称**: Souls-Like 游戏渲染引擎
- **开发周期**: 2个月，8周
- **团队规模**: 2人
- **技术栈**: OpenGL + C++17
- **目标**: 实现基础功能，35分+ 高级功能，争取40分

---

## 阶段规划

### 第一阶段：基础功能实现（1-2周）
**目标**: 搭建项目框架，实现基础渲染功能

#### 第1周：项目搭建与基础渲染
- [ ] **Day 1-2**: 项目搭建
  - 搭建CMake构建系统
  - 配置依赖（GLFW、GLAD、GLM、stb_image等）
  - 配置开发环境Visual Studio / CLion / VS Code + CMake
  - 创建OpenGL窗口和渲染上下文（GLFW）
  - 初始化GLAD获取OpenGL函数指针
  - 配置OpenGL状态和版本支持

- [ ] **Day 3-4**: 基础渲染系统
  - 实现Shader管理系统（从文件加载GLSL）
  - 实现Shader程序管理
  - 实现基础渲染循环（Render Loop）
  - 实现相机系统（Camera System）
  - 学习GLM（MVP矩阵计算）

- [ ] **Day 5-7**: 基础几何体渲染
  - 实现立方体（Cube）渲染
  - 实现球体（Sphere）渲染
  - 实现圆柱体（Cylinder）渲染
  - 实现圆锥体（Cone）渲染
  - 实现棱柱（Prism）渲染
  - 实现棱台（Frustum）渲染

**里程碑**: 能够渲染基础几何体和坐标轴

---

#### 第2周：场景管理与变换系统
- [ ] **Day 1-3**: 场景图（Scene Graph）系统
  - 实现场景节点（Node）结构
  - 实现父子节点关系
  - 实现场景遍历
  - 实现对象管理器（Object Manager）

- [ ] **Day 4-5**: 变换系统（加分4分）
  - 实现旋转（Rotation）变换
  - 实现平移（Translation）变换
  - 实现缩放（Scale）变换
  - 实现变换矩阵计算
  - 实现局部/全局坐标变换

- [ ] **Day 6-7**: 材质系统
  - 实现材质数据结构
  - 实现基础着色器参数
  - 实现材质属性修改功能

**里程碑**: 完成场景图和变换系统

---

### 第二阶段：高级功能实现（3-4周）
**目标**: 实现高级渲染功能

#### 第3周：纹理与材质系统（加分2分、3分）
- [ ] **Day 1-3**: 纹理系统
  - 使用stb_image加载图片（PNG/JPG）
  - 实现纹理封装（Texture类）
  - 实现纹理绑定和管理（glBindTexture）
  - 实现UV坐标映射
  - 实现纹理采样模式设置（过滤、环绕模式）

- [ ] **Day 4-5**: 材质编辑系统（加分3分）
  - 实现材质数据结构（Material类）
  - 实现材质编辑器（颜色、贴图、透明度）
  - 实现材质预览渲染
  - 实现材质序列化/反序列化（JSON格式）

- [ ] **Day 6-7**: 模型加载与渲染（加分2分）
  - 实现OBJ格式模型加载（推荐使用tinyobjloader）
  - 实现OBJ模型解析（顶点、法线、UV等）
  - 实现OBJ模型渲染
  - 可选使用Assimp支持更多格式（DAE、FBX等）

**里程碑**: 完成纹理系统和模型IO系统

---

#### 第4周：光照系统（加分5分、6分）
- [ ] **Day 1-3**: 光照模型实现（加分5分）
  - 实现Phong光照模型
  - 实现环境光（Ambient Light）
  - 实现方向光（Directional Light）
  - 实现点光源（Point Light）
  - 实现聚光灯（Spot Light）

- [ ] **Day 4-5**: 光源编辑系统（加分5分）
  - 实现光源属性控制（位置、强度、颜色）
  - 实现光源可视化Gizmo显示
  - 实现光源添加/删除
  - 实现光源保存

- [ ] **Day 6-7**: 相机控制优化（加分6分）
  - 实现Orbit模式（环绕目标旋转）
  - 实现Pan模式（平移场景）
  - 实现Zoom In/Out（缩放）
  - 实现Zoom To Fit（适配视图）
  - 实现第一人称/第三人称切换

**里程碑**: 完成光照系统和相机控制优化

---

### 第三阶段：动画与游戏功能实现（5-6周）
**目标**: 实现动画功能，开始游戏系统设计

#### 第5周：动画系统与场景编辑（加分7分）
- [ ] **Day 1-3**: 动画系统
  - 实现关键帧数据结构
  - 实现动画时间线
  - 实现帧数据插值计算
  - 实现动画控制逻辑（播放/暂停/停止）

- [ ] **Day 4-5**: 截图与保存功能（加分7分）
  - 使用glReadPixels读取帧缓冲区
  - 实现将截图保存为PNG/JPG（使用stb_image_write）
  - 实现截图格式选择
  - 实现截图自动保存（F12快捷键）

- [ ] **Day 6-7**: 场景编辑功能
  - 实现场景选择系统（射线检测）
  - 实现场景编辑器（使用ImGui构建UI）
  - 实现场景序列化/反序列化（使用nlohmann/json自动格式化）

**里程碑**: 完成动画功能和场景编辑器

---

#### 第6周：游戏系统设计与基础功能实现
- [ ] **Day 1-2**: 输入系统
  - 使用GLFW实现输入检测
  - 实现按键映射
  - 实现鼠标映射

- [ ] **Day 3-4**: 地图结构
  - 创建第一个检查点（Checkpoint）
  - 创建第二个检查点
  - 设计游戏路径
  - 设计简单交互

- [ ] **Day 5-6**: 场景装饰
  - 添加基本装饰物（石头、墙壁、障碍物）
  - 添加场景细节（提升游戏氛围）
  - 调整光照效果

- [ ] **Day 7**: 系统整合与优化
  - 修复功能兼容性问题
  - 优化渲染效果
  - 调整游戏平衡性

**里程碑**: 实现基础游戏地图（2个检查点+简单交互）

---

### 第四阶段：游戏功能完善（7-8周）
**目标**: 实现基础游戏功能（时间不充裕可跳过）

#### 第7周：角色控制系统
- [ ] **Day 1-2**: 输入系统
  - 实现键盘控制映射
  - 实现鼠标控制映射
  - 实现输入状态管理

- [ ] **Day 3-4**: 碰撞检测系统（高级功能加分2分）
  - 实现AABB碰撞检测
  - 实现射线碰撞检测
  - 实现碰撞响应
  - 实现碰撞调试可视化（线框模式）

- [ ] **Day 5-7**: 角色移动系统
  - 实现角色移动（WASD）
  - 实现角色旋转
  - 实现角色跳跃状态
  - 实现角色移动动画

**里程碑**: 完成角色控制系统

---

#### 第8周：游戏系统完善
**核心目标**:
- [ ] **Day 1-2**: 交互系统
  - 实现交互提示（E键提示）
  - 实现交互点触发器
  - 实现交互事件处理

- [ ] **Day 3-4**: 战斗系统（加分：时间充裕）
  - 实现基础攻击
  - 实现敌人AI
  - 实现伤害计算
  - 实现角色死亡

- [ ] **Day 5-6**: 生命系统（加分：时间充裕）
  - 实现生命值显示
  - 实现角色受伤
  - 实现死亡/重生

- [ ] **Day 7**: 最终整合与优化
  - 系统整合
  - Bug修复
  - 性能优化
  - 准备演示

**可选项目**（时间充裕）:
- 相机控制高级优化
- 更复杂的交互系统和交互点
- 扩展战斗系统
- 确保系统完整可用

**里程碑**: 完成游戏原型和基本功能演示

---

## 高级功能实现方案（加分项）

### 优先实现的高级功能（按优先级排序）

1. **实时阴影系统**（高级功能加分2分 - 第7周实现）
   - 难度：中等
   - 加分：5分
   - 状态：已批准

2. **地形渲染**（高级功能加分7分 - 自由时间实现）
   - 实现基于高度图的地形系统
   - 难度：中-高级
   - 加分：5分
   - 实现时间：第6周

3. **法线贴图效果**（高级功能加分8分）
   - 实现法线贴图（Normal Mapping）
   - 实现高光贴图（Specular Mapping）
   - 难度：中等
   - 加分：5分
   - 实现时间：第3周末至第8周

4. **高级游戏机制**（高级功能加分5分）
   - 实现复杂游戏机制
   - 难度：高级
   - 加分：5分
   - 实现时间：第7-8周

**目标**: 实现2-3个高级功能，争取满分40分

---

## 技术栈详情

### 核心技术栈：OpenGL + C++17
- **渲染API**: OpenGL 3.3+ / 4.6
- **开发语言**: C++17
- **窗口库**: GLFW 3.3+
- **OpenGL加载库**: GLAD（或GL3W）
- **数学库**: GLM（OpenGL Mathematics）
- **图像加载**: stb_image（头文件库）
- **图像保存**: stb_image_write
- **构建系统**: CMake 3.15+
- **JSON解析**: nlohmann/json（可选，用于场景序列化）
- **模型加载**: tinyobjloader（OBJ格式）或 Assimp（多格式）
- **UI库**: Dear ImGui（用于编辑器界面，可选）

### 开发工具链

**Windows平台**:
- **IDE**: Visual Studio 2019/2022 或 CLion
- **编译器**: MSVC 或 MinGW-w64
- **调试器**: Visual Studio Debugger 或 GDB

**Linux平台**:
- **IDE**: CLion 或 VS Code + CMake插件
- **编译器**: GCC 9+ 或 Clang 10+
- **调试器**: GDB

**macOS平台**:
- **IDE**: Xcode 或 CLion
- **编译器**: Clang（Xcode Command Line Tools）
- **调试器**: LLDB

### 依赖库安装方式

**使用vcpkg包管理器**:
```bash
vcpkg install glfw3 glad glm stb
```

**使用Conan**:
```bash
conan install glfw/3.3.8@
conan install glm/0.9.9.8@
```

**手动安装**: 参考相关GitHub仓库说明

### 项目配置要求
- 确保OpenGL版本兼容性（最低3.3版）
- 使用GLAD生成对应版本的加载文件
- 正确配置CMake项目和包含路径
- 统一资源文件路径（如shader路径）和资源根目录

### C++项目实践说明

**1. 开发环境搭建（第1周前完成）**
```bash
# Windows示例（使用vcpkg）
git clone https://github.com/Microsoft/vcpkg.git
cd vcpkg
.\bootstrap-vcpkg.bat
.\vcpkg integrate install
.\vcpkg install glfw3:x64-windows
.\vcpkg install glm:x64-windows
.\vcpkg install stb:x64-windows

# 配置CMake使用vcpkg
cmake -B build -S . -DCMAKE_TOOLCHAIN_FILE=[vcpkg目录]/scripts/buildsystems/vcpkg.cmake
```

**2. 开发流程规范**
```
编写代码（.h/.cpp文件）
    ↓
编译检查
    ↓
构建（CMake + 编译器）
    ↓
生成可执行文件（.exe等）
    ↓
程序运行
    ↓
查看结果/调试
```

**3. 构建命令示例**
```bash
# 配置项目
cmake -B build -S . -DCMAKE_BUILD_TYPE=Debug

# 构建
cmake --build build --config Debug

# 运行（Windows）
.\build\Debug\SoulsEngine.exe

# 运行（Linux/Mac）
./build/SoulsEngine
```

**4. 调试方法**
- **Visual Studio**: F5开始调试，F9设置断点，F10单步执行
- **CLion**: 右键设置断点，Shift+F9开始调试
- **GDB**: `gdb ./SoulsEngine` -> `break main` -> `run`

**5. OpenGL错误检查**
```cpp
#define GL_CHECK_ERROR() \
    do { \
        GLenum err = glGetError(); \
        if (err != GL_NO_ERROR) { \
            std::cerr << "OpenGL Error: " << err << " at " << __FILE__ << ":" << __LINE__ << std::endl; \
        } \
    } while(0)
```

---

## 项目结构设计

```
Souls-Engine/
├── CMakeLists.txt         # CMake配置文件
├── cmake/                 # CMake模块
│   └── FindGLFW.cmake
├── src/
│   ├── core/              # 核心系统
│   │   ├── Renderer.h/cpp # 渲染器
│   │   ├── Camera.h/cpp   # 相机系统
│   │   ├── Scene.h/cpp    # 场景系统
│   │   ├── Shader.h/cpp   # Shader管理
│   │   ├── Window.h/cpp   # 窗口系统（GLFW封装）
│   ├── geometry/          # 几何模块
│   │   ├── Mesh.h/cpp     # 网格基类
│   │   ├── Cube.h/cpp
│   │   ├── Sphere.h/cpp
│   │   ├── Cylinder.h/cpp
│   │   ├── Cone.h/cpp
│   │   ├── Prism.h/cpp
│   │   └── Frustum.h/cpp
│   ├── material/          # 材质系统
│   │   ├── Material.h/cpp
│   │   ├── Texture.h/cpp
│   ├── lighting/          # 光照系统
│   │   ├── Light.h/cpp
│   │   ├── PhongShader.h/cpp
│   ├── io/                # 加载与保存
│   │   ├── OBJLoader.h/cpp
│   │   ├── OBJExporter.h/cpp
│   ├── animation/         # 动画系统
│   │   ├── Animation.h/cpp
│   ├── game/              # 游戏逻辑
│   │   ├── Player.h/cpp
│   │   ├── Checkpoint.h/cpp
│   │   ├── Combat.h/cpp
│   ├── ui/                # UI系统（可能使用ImGui）
│   │   ├── EditorUI.h/cpp
│   ├── utils/             # 工具类和辅助
│       ├── MathUtils.h/cpp
│       ├── FileUtils.h/cpp
├── assets/                # 资源文件
│   ├── models/
│   ├── textures/
│   ├── shaders/
│       ├── vertex.glsl
│       ├── fragment.glsl
├── include/               # 第三方头文件（非必要）
│   ├── glad/
│   ├── KHR/
├── lib/                   # 第三方库（Windows DLL等）
├── build/                 # 构建输出目录（gitignore）
├── README.md
```

### CMakeLists.txt 示例结构
```cmake
cmake_minimum_required(VERSION 3.15)
project(SoulsEngine)

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# 查找依赖
find_package(glfw3 REQUIRED)
find_package(glm REQUIRED)

# 包含目录
include_directories(${CMAKE_SOURCE_DIR}/include)
include_directories(${CMAKE_SOURCE_DIR}/src)

# 源文件
file(GLOB_RECURSE SOURCES "src/*.cpp" "src/*.h")

# 可执行文件
add_executable(${PROJECT_NAME} ${SOURCES} src/main.cpp)

# 链接库
target_link_libraries(${PROJECT_NAME} 
    glfw
    ${CMAKE_DL_LIBS}  # 包含GLAD的动态链接
)

# 资源文件复制（Windows）
if(WIN32)
    add_custom_command(TARGET ${PROJECT_NAME} POST_BUILD
        COMMAND ${CMAKE_COMMAND} -E copy_directory
        ${CMAKE_SOURCE_DIR}/assets $<TARGET_FILE_DIR:${PROJECT_NAME}>/assets
    )
endif()
```

---

## 进度检查

### 检查点1（第2周末）
- ? 基础几何物体渲染
- ? 场景图系统实现
- ? 变换系统实现

### 检查点2（第4周末）
- ? 材质系统实现（加分1-6分）
- ? 光照系统实现
- ? 纹理系统实现
- ? 模型系统实现

### 检查点3（第6周末）
- ? 动画系统实现（加分7分）
- ? 游戏地图基础实现
- ? 基础功能完成（35分）

### 检查点4（第8周末）
- ? 游戏系统完善（建议有演示效果）
- ? 高级功能实现（争取40分）
- ? 项目展示准备

---

## 注意事项

### 关键约束
1. **时间有限**: 首先保证基础功能，游戏功能可搁置
2. **团队协作**: 及时整合和测试功能模块
3. **学习成本**: 提前学习和准备相关知识
4. **项目初始化**: C++项目较为复杂，提前完成环境搭建
5. **内存管理**: C++需要手动管理内存，注意内存泄漏
6. **跨平台差异**: 不同平台OpenGL版本和扩展支持可能不同

### 应对策略
- **每周整合**: 每周完成后，及时整合
- **功能优先级**: 基础功能 > 高级功能 > 游戏功能
- **可选项目**: 游戏功能为可选，优先确保渲染系统演示
- **环境准备**: 第1周前完成开发环境的搭建和配置
- **内存安全**: 注意内存管理，确保资源正确释放和内存安全
- **工具使用**: 使用Valgrind（Linux）或Visual Studio内置工具检测内存泄漏

---

## 分工安排（2人团队）

### 成员A（渲染系统）
- 负责渲染管线、着色器、光照和材质系统
- 时间：第1-4周重点负责
- 需要技能：熟悉OpenGL、GLSL、图形学知识

### 成员B（游戏系统）
- 负责模型IO系统、动画系统、游戏逻辑和UI系统
- 时间：第3-8周重点负责
- 需要技能：熟悉C++、文件IO和数据结构

### 协作要求
- 共同设计核心接口
- 共同整合和测试
- 文档编写共同负责

---

## 每周进度报告模板

### 第X周进度报告
- [ ] 任务1
- [ ] 任务2
- [ ] 任务3
...

**完成目标**: 
**完成度**: ___%

---

## 代码规范

1. **命名规范**: 
   - 统一采用Google C++ Style Guide 或 LLVM Style
   - 使用智能指针管理动态分配内存，避免内存泄漏
   - 合理使用const限定符
   - 头文件使用#pragma once 或 include guard

2. **内存管理**:
   - 使用RAII原则
   - OpenGL资源（VAO、VBO等）使用后必须正确释放
   - 避免野指针和空指针

3. **版本控制**:
   - 使用Git进行版本管理
   - .gitignore文件包含build/、*.exe、*.dll等
   - 不要提交不必要的中间文件

4. **构建配置**:
   - Debug模式包含详细日志
   - Release模式优化性能和减少输出
   - 使用不同的CMake构建配置

5. **资源路径**:
   - 使用相对路径访问资源目录
   - 确保运行时能找到shaders、textures等资源
   - Windows注意路径分隔符

6. **调试辅助**:
   - 使用GL_CHECK检查OpenGL错误
   - 使用RenderDoc进行帧捕获调试
   - 使用断点和日志记录

7. **跨平台兼容**:
   - 路径分隔符统一（/ vs \）
   - 文件编码统一（UTF-8）
   - 函数调用方式统一

---

## 总结

设计方案要点
- ? 实现7周基础功能（35分）
- ? 实现2-3个高级功能（加分5-10分）
- ? 完成游戏原型设计
- ? 实现游戏基础功能（时间充裕）

**成功关键因素**:
1. 详细的计划执行
2. 每周进度检查
3. 首先保证基础功能
4. 及时沟通协作

祝项目顺利！